<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>掲示板テスト</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 表示エリアの改行を有効にする */
        #d p {
            white-space: pre-wrap; /* これで改行がそのまま表示されます */
            word-wrap: break-word; /* 長い単語の折り返し設定 */
            border-bottom: 1px solid #eee;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>掲示板</h1>
    <input type="text" id="u" placeholder="名前">
    <textarea id="m" placeholder="内容"></textarea>
    <button onclick="send()">送信</button>
    <div id="d">読み込み中...</div>

    <script>
        const myApp = supabase.createClient('https://dcxjmocivftnoeanxozp.supabase.co', 'sb_publishable_jMGLh45RmTHYqf8oP-9ymw_T2eHxW-M');

        async function load() {
            // .order() を外すか、確実に存在する列名に変更
            const { data, error } = await myApp.from('posts').select('*');
            
            if (error) {
                console.error("読み込みエラー:", error.message);
                return;
            }

            if (data) {
                // 新しいものが上にくるようにJS側で逆順にする
                const reversedData = [...data].reverse();
                document.getElementById('d').innerHTML = reversedData.map(p => `<p><b>${p.name || '名無し'}</b>: ${p.content}</p>`).join('');
            }
        }

        async function send() {
            const n = document.getElementById('u').value || "名無し";
            const c = document.getElementById('m').value;
            if (!c) return;

            const { error } = await myApp.from('posts').insert([{ name: n, content: c }]);
            
            if (error) {
                alert("送信エラー: " + error.message + "\nポリシーで 'anon' ロールが許可されているか確認してください。");
            } else {
                document.getElementById('m').value = "";
                load();
            }
        }

        load();
        setInterval(load, 5000);
    </script>
</body>
</html>